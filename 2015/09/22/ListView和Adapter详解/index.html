<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ListView和Adapter详解 · 一派胡言</title><meta name="description" content="ListView和Adapter详解 - Jian Zhang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://threezj.com/atom.xml" title="一派胡言"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/zyycj" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ListView和Adapter详解</h1><div class="post-info">2015年9月22日</div><div class="post-content"><h2 id="什么是ListView"><a href="#什么是ListView" class="headerlink" title="什么是ListView"></a>什么是ListView</h2><blockquote>
<p>ListView is a view group that displays a list of scrollable items. The list items are automatically inserted to the list using an Adapter that pulls content from a source such as an array or database query and converts each item result into a view that’s placed into the list.</p>
</blockquote>
<p>其实很容易理解，ListView就是一个能数据集合以动态滚动的方式展示到用户界面上的View。<br><a id="more"></a></p>
<h2 id="ListView和Adapter"><a href="#ListView和Adapter" class="headerlink" title="ListView和Adapter"></a>ListView和Adapter</h2><p>ListView和数据是分开的，不直接接触。而是通过Adapter(适配器)加载到屏幕。也就是说Adapter相当于是数据和View之间的桥梁。Adapter负责为每一个数据项制作View。</p>
<p><img src="http://ww4.sinaimg.cn/mw690/87dacc16gw1ewbbhro6s3j20dr0agwfb.jpg" alt="ListView原理"></p>
<h2 id="ListView工作原理"><a href="#ListView工作原理" class="headerlink" title="ListView工作原理"></a>ListView工作原理</h2><p>在运行时ListView会针对数据项向Adapter要View，从而来加载到界面上。那么，难道每一个item，Adapter都会重新创建一个视图吗？答案很明显是不可能的。</p>
<p>为了能够更快更省空间的显示，Android准备了一个叫做Recycler(循环)的组件。假如你的屏幕只能显示七个item。那么ListView只会创建八个item的视图。当第一个item出去，离开屏幕的时候，这个item的view就会被拿来重用，显示下一个item的内容。</p>
<p><img src="http://android.amberfog.com/wp-content/uploads/2010/02/listview_recycler.jpg" alt="Recycler"></p>
<h2 id="继承BaseAdapter来使用ListView"><a href="#继承BaseAdapter来使用ListView" class="headerlink" title="继承BaseAdapter来使用ListView"></a>继承BaseAdapter来使用ListView</h2><p>BaseAdapter是个抽象类，继承它能很方便的来使用ListView。要覆写四个方法。前三个都很简单。重点是getView方法，这直接决定你的屏幕加载是否顺滑。</p>
<ol>
<li>如果convertView为空，加载布局创建View</li>
<li>若不空，则直接通过position，获取list中的item，直接替换view中的内容。</li>
</ol>
<p>很清楚了吧？convertView就是一个View缓冲器。这里的getview的demo不是很好。因为findViewById()这个函数执行代价很大。所以不建议用这种方式，每次都加载控件。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDataAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyDataAdapter"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据源</span></span><br><span class="line">    List&lt;MyDataClass&gt; mData = <span class="keyword">null</span>;</span><br><span class="line">    Context mContext = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDataAdapter</span><span class="params">(Context context, List&lt;MyDataClass&gt; data)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mData = data;</span><br><span class="line">        counter = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据源中的数据对象个数</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mData.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定位置处的数据源对象</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mData.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据源对象的Id,如果有的话</span></span><br><span class="line">    <span class="comment">//如果数据源对象自己没有定义Id，则可以简单地返回其在数据源中的位置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//每当Android ListView需要显示一行时，它会调用此方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"显示："</span> + position + <span class="string">"行，调用getView()"</span> + <span class="string">"参数convertView==null?"</span> + (convertView == <span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line">        View rootView = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//如果没有可以重用的控件</span></span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LayoutInflater inflater = LayoutInflater.from(mContext);</span><br><span class="line">            rootView = inflater.inflate(R.layout.my_list_item, parent, <span class="keyword">false</span>); <span class="comment">//加载布局，创建View</span></span><br><span class="line">            rootView.setTag(position);</span><br><span class="line">            Log.d(TAG, <span class="string">"实例化rootView，保存到Tag中的值为:"</span> + position);</span><br><span class="line">            counter++;</span><br><span class="line">            Log.d(TAG, <span class="string">"控件实例化个数："</span> + counter);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//控件己经被创建过，直接重用</span></span><br><span class="line">            rootView = convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//依据位置提取相应的数据源对象</span></span><br><span class="line">        MyDataClass item = mData.get(position);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取用于显示内容的控件的引用</span></span><br><span class="line">        TextView titleTextView = (TextView) rootView.findViewById(R.id.tvTitle);</span><br><span class="line">        TextView detailTextView = (TextView) rootView.findViewById(R.id.tvDetail);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置显示内容</span></span><br><span class="line">        titleTextView.setText(item.getTitle());</span><br><span class="line">        detailTextView.setText(item.getDetail() + <span class="string">" 本行Tag中保存的值为:"</span> + rootView.getTag());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rootView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ViewHolder设计模式"><a href="#ViewHolder设计模式" class="headerlink" title="ViewHolder设计模式"></a>ViewHolder设计模式</h2><p>创建一个内部类ViewHolder保存控件。只加载View的时候使用findViewById()方法。使用View的setTag()方法保存ViewHolder。当convertView不为空的时候，直接取出来即可<br>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">    ViewHolder holder=<span class="keyword">null</span>;</span><br><span class="line">    View rootView=convertView;</span><br><span class="line">    <span class="keyword">if</span>(convertView==<span class="keyword">null</span>)&#123;</span><br><span class="line">        LayoutInflater layoutInflater = LayoutInflater.from(context);</span><br><span class="line">        rootView = layoutInflater.inflate(R.layout.phoneinfo_item, parent, <span class="keyword">false</span>);</span><br><span class="line">        holder=<span class="keyword">new</span> ViewHolder();</span><br><span class="line">        holder.nameText= (TextView) rootView.findViewById(R.id.nameText);</span><br><span class="line">        holder.numberText= (TextView) rootView.findViewById(R.id.numberText);</span><br><span class="line">        rootView.setTag(holder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        holder= (ViewHolder) rootView.getTag();</span><br><span class="line">    &#125;</span><br><span class="line">    PhoneInfo phoneInfo = phoneInfoList.get(position);</span><br><span class="line">    holder.nameText.setText(phoneInfo.getPhoneName());</span><br><span class="line">    holder.numberText.setText(phoneInfo.getPhoneNumber());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rootView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> TextView nameText =<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> TextView numberText=<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="含有多种视图的布局ListView"><a href="#含有多种视图的布局ListView" class="headerlink" title="含有多种视图的布局ListView"></a>含有多种视图的布局ListView</h2><p>这应该是一种比较常见的情况。</p>
<p>如果你要加载多种布局那么<strong>首先你一定重写这两个方法</strong></p>
<p><strong>注意！type一定要从0开始！！</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    BaseModel baseModel=models.get(position);</span><br><span class="line">    <span class="keyword">int</span> type=baseModel.getType();</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewTypeCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>剩下的重点getView()其实也很简单啦，也就是弄多个ViewHolder保存即可<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">    BaseModel baseModel=models.get(position);</span><br><span class="line">    <span class="keyword">int</span> type=getItemViewType(position);</span><br><span class="line">    HeaderViewHolder headerViewHolder=<span class="keyword">null</span>;</span><br><span class="line">    DetailViewHolder detailViewHolder=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(convertView==<span class="keyword">null</span>)&#123;</span><br><span class="line">        LayoutInflater layoutInflater=LayoutInflater.from(context);</span><br><span class="line">        <span class="keyword">if</span>(type==<span class="number">0</span>)&#123;</span><br><span class="line">            headerViewHolder=<span class="keyword">new</span> HeaderViewHolder();</span><br><span class="line">            convertView=layoutInflater.inflate(R.layout.header_item,<span class="keyword">null</span>);</span><br><span class="line">            headerViewHolder.headerText= (TextView) convertView.findViewById(R.id.headerText);</span><br><span class="line">            convertView.setTag(headerViewHolder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">1</span>)&#123;</span><br><span class="line">            detailViewHolder=<span class="keyword">new</span> DetailViewHolder();</span><br><span class="line">            convertView=layoutInflater.inflate(R.layout.detail_item,<span class="keyword">null</span>);</span><br><span class="line">            detailViewHolder.contentText= (TextView) convertView.findViewById(R.id.contentText);</span><br><span class="line">            detailViewHolder.detailText=(TextView) convertView.findViewById(R.id.detailText);</span><br><span class="line">            detailViewHolder.clickBtn= (Button) convertView.findViewById(R.id.clickButton);</span><br><span class="line">            convertView.setTag(detailViewHolder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>  &#123;</span><br><span class="line">        <span class="keyword">if</span>(type==<span class="number">0</span>)</span><br><span class="line">            headerViewHolder= (HeaderViewHolder) convertView.getTag();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">1</span>)</span><br><span class="line">            detailViewHolder= (DetailViewHolder) convertView.getTag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(type==<span class="number">0</span>)&#123;</span><br><span class="line">        HeaderModel headerModel= (HeaderModel) baseModel;</span><br><span class="line">        headerViewHolder.headerText.setText(headerModel.getHeader());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(type==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">final</span> DetailModel detailModel= (DetailModel) baseModel;</span><br><span class="line">        detailViewHolder.contentText.setText(detailModel.getContext());</span><br><span class="line">        detailViewHolder.detailText.setText(detailModel.getDetail());</span><br><span class="line">        detailViewHolder.clickBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                Toast.makeText(context,detailModel.getContext()+<span class="string">"被点击"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> convertView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderViewHolder</span> </span>&#123;</span><br><span class="line">    TextView headerText=<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DetailViewHolder</span> </span>&#123;</span><br><span class="line">    TextView contentText=<span class="keyword">null</span>;</span><br><span class="line">    TextView detailText=<span class="keyword">null</span>;</span><br><span class="line">    Button clickBtn=<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实在弄不清楚可以看我的github项目 <a href="https://github.com/threezj/AndroidSimpleProject/tree/master/ListViewEventDemo" target="_blank" rel="noopener">ListViewEventDemo</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/09/25/onServiceConnected方法没有回调的解决方案/" class="prev">上一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2015/09/22/ListView和Adapter详解/';
var disqus_title = 'ListView和Adapter详解';
var disqus_url = 'http://threezj.com/2015/09/22/ListView和Adapter详解/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://threezj.com">Jian Zhang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>